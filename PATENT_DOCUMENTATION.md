# OPICTUARY DIGITAL MEMORIAL PLATFORM
## Comprehensive Patent Application Documentation

---

## DOCUMENT INFORMATION

**Application Title:** Integrated Digital Memorial Platform with Physical-Digital Linkage and Specialized Access Control Systems

**Applicant:** [YOUR NAME/COMPANY]

**Date Prepared:** November 6, 2025

**Technology Classification:** Computer Software, Social Networking, Digital Content Management, Security Systems

**Document Purpose:** Technical specification for patent application preparation

---

## TABLE OF CONTENTS

1. Abstract
2. Field of the Invention
3. Background
4. Summary of the Invention
5. Detailed System Architecture
6. Novel Features and Claims
7. Technical Implementation
8. Business Model
9. Database Architecture
10. Security and Privacy Systems
11. Integration Ecosystem
12. Appendices

---

## 1. ABSTRACT

This invention relates to a comprehensive digital memorial platform (Opictuary) that bridges physical memorial sites with digital content through dynamic QR code technology, provides specialized access control for restricted populations, implements time-delayed legacy messaging systems, and creates community-based memorial networks. The system uniquely combines physical-to-digital memorial linking, incarceration-compatible access protocols, neighborhood-based community memorials, multi-faith spiritual customization, temporal message scheduling with recurrence patterns, and integrated funeral service management with audio synchronization capabilities.

The platform generates revenue through configurable transaction fees (2.5%-5%), business partnerships (funeral homes at 10-15% commission, flower shops at 20% commission), prison access services ($0.15/minute), and targeted memorial page advertisements. Key innovations include: (1) QR codes on tombstones that dynamically update as content is added, (2) secure time-limited access tokens for incarcerated individuals with audit logging, (3) future message delivery system with yearly/monthly recurrence, (4) Bluetooth-enabled funeral programs with synchronized audio, and (5) neighborhood memorial walls for community legends.

---

## 2. FIELD OF THE INVENTION

This invention pertains to the technical fields of:
- Digital content management and social networking platforms
- Physical-digital integration systems using machine-readable codes
- Secure access control and authentication for restricted populations
- Time-based content delivery and scheduling systems
- Multi-platform Progressive Web Applications (PWA)
- Payment processing and commission management systems
- Geographic information systems for cemetery mapping
- Real-time streaming and multimedia content delivery
- Database-driven content moderation systems

---

## 3. BACKGROUND

### 3.1 Problems with Existing Memorial Platforms

**Physical-Digital Disconnect:**
Traditional memorial websites lack integration with physical memorial sites (tombstones, plaques, memorial cards). Visitors to cemeteries cannot easily access digital content associated with the deceased. Existing QR code implementations are static and require regeneration when content changes.

**Access Barriers for Incarcerated Individuals:**
Approximately 1.9 million individuals are incarcerated in the United States at any given time. These individuals face significant barriers to maintaining connections with deceased loved ones due to:
- Restricted internet access
- Limited phone call availability
- Security monitoring requirements
- Payment processing limitations with correctional facility systems
- Lack of platforms designed for supervised, time-limited access

**Temporal Communication Gap:**
There exists no comprehensive system for deceased individuals to pre-schedule messages to loved ones for future milestones (birthdays, graduations, weddings). Existing solutions lack:
- Recurrence pattern support (yearly anniversaries)
- Template systems for common occasions
- Media attachment capabilities
- Central management dashboards across multiple memorials

**Community Memorial Fragmentation:**
Neighborhood legends and community figures lack dedicated memorial spaces that reflect their local impact. Celebrity and public figure memorials lack:
- Profession-specific categorization systems
- Estate-controlled exclusive content platforms
- Verification systems for family/legal representatives
- Charity integration with transparent donation tracking

**Service Coordination Inefficiency:**
Funeral service planning lacks integrated tools for:
- Audio-synchronized order of service programs
- Bluetooth connectivity for wireless speaker systems
- Live streaming with viewer tracking
- Digital program creation and distribution

### 3.2 Technical Limitations of Prior Art

1. **Static QR Codes:** Existing systems use fixed QR codes that link to unchanging URLs, requiring reprinting when content updates
2. **No Correctional Facility Integration:** Memorial platforms lack payment integration with prison communication services (ConnectNetwork, ViaPath, Securus)
3. **Limited Temporal Scheduling:** Basic email scheduling lacks memorial context, recurrence patterns, and centralized management
4. **Generic Memorial Templates:** One-size-fits-all approach without profession-specific fields or multi-faith customization
5. **Fragmented Business Partnerships:** Lack of integrated commission tracking for funeral homes, florists, and merchandise vendors

---

## 4. SUMMARY OF THE INVENTION

Opictuary is a comprehensive digital memorial platform comprising:

### 4.1 Core System Components

**A. Physical-Digital Memorial Bridge**
- Dynamic QR code generation system with three operational modes:
  1. **Tombstone Upload Mode:** Allows cemetery visitors to upload photos/videos via QR scan
  2. **Memorial View Mode:** Direct link to memorial page for viewing existing content
  3. **General Upload Mode:** For memorial cards and keepsakes
- QR codes automatically update backend links as families add new content
- Professional PDF generation with purple/gold branding (280° hue, 45° hue)
- Tagline integration: "Preserving Memories. Honoring Lives."
- Weather-resistant design specifications for outdoor placement

**B. Prison Access Control System**
- Secure, monitored memorial access for incarcerated individuals
- Identity verification workflow:
  - Inmate first name, last name, DOC number
  - Facility identification and selection
  - Relationship to deceased verification
  - Proof of relationship document upload
- Payment integration with correctional facility systems:
  - ConnectNetwork/GTL
  - ViaPath Technologies  
  - Securus Technologies
- Time-limited access token generation (configurable duration)
- Session monitoring with timestamp tracking
- Complete audit logging system:
  - Request creation events
  - Status change tracking
  - Session validation logs
  - Access token expiration events
- Per-minute pricing model ($0.15/minute default)

**C. Future Messages System**
- Scheduled message delivery for future dates
- Support for 11 event types:
  - Birthday, Graduation, Wedding, Anniversary
  - Baby Birth, Mother's Day, Father's Day
  - Christmas, New Year, Holidays, Custom Events
- Recurrence pattern support:
  - Yearly (annual anniversaries)
  - Monthly  
  - Custom intervals
- 60+ pre-written message templates categorized by occasion
- Multiple media attachment support (photos, videos, documents)
- Four message statuses: draft, pending, sent, failed
- Global dashboard for managing messages across all memorials
- Filter system: Upcoming, Next 7 Days, Next 30 Days, Drafts, Sent
- Email delivery mechanism with configurable send time (HH:MM format)

**D. Neighborhood Memorial System (Hood Memorials)**
- Community-based memorial walls for local legends
- Neighborhood profile management:
  - Name, city, state, coordinates
  - Logo/branding upload
  - Historical information
  - Founder information
  - Statistical tracking (founded year, population)
- Memorial-specific fields:
  - Neighborhood name and logo
  - Club affiliation and logo
  - Community impact description
  - "Known for" highlights
  - Local legacy documentation
- City/state composite indexing for geographic search
- Creator authentication requirement

**E. Celebrity Memorial System**
- Interactive profession categorization (10 primary categories):
  - Sports, Actors/Actresses, Musicians, Royalty
  - Politicians, Authors, Activists, Business Leaders
  - Scientists/Inventors, Religious Leaders
- Sub-profession selection for specialized fields
- 4-step creation wizard:
  1. Basic Information (name, profession, dates, bio)
  2. Charity Integration (organization, donation amount, platform percentage)
  3. Achievements & Awards (structured data entry with years)
  4. Family/Legal Verification (relationship proof, document upload)
- Estate-controlled fan content platform:
  - Admin-only content creation and publishing
  - Draft management system
  - View count tracking
  - Four content types: video messages, photos, videos, audio messages
- Verification system:
  - Pending/approved/rejected status workflow
  - Document upload for proof
  - Admin review process
  - Verification timestamp tracking
- Higher platform fees (5% vs standard 3%)

**F. Essential Worker Memorial System**
- Guided creation flow for first responders:
  - Police Officers (badge number, precinct, rank)
  - Firefighters (station, badge number, rank)
  - Healthcare Workers (unit, specialization, certifications)
  - Military Personnel (branch, rank, deployments, unit)
  - Teachers, EMTs/Paramedics
- Category-specific professional detail fields:
  - Rank and badge numbers
  - Department/unit assignments
  - Years of service calculation
  - Line-of-duty death designation
  - Honors and awards (structured JSON)
  - Deployment history (location, years, campaign)
  - Professional certifications array
- Category-based indexing for filtering

**G. Funeral Program Audio & Bluetooth System**
- Digital funeral program creation tool
- Program-level background audio support
- Item-level audio clips for specific program elements:
  - Readings
  - Eulogies
  - Musical selections
  - Prayers
- Bluetooth connectivity features:
  - Enable/disable toggle
  - Bluetooth device name specification
  - Wireless speaker pairing support
- Customizable order of service
- Theme color selection
- Cover image upload
- Service location and time details
- Family information display
- Special thanks section
- Repast location information

### 4.2 Supporting Features

**H. Interactive Memorial Gallery**
- Lightbox modal for full-size photo/video viewing
- Heart reaction system with real-time counts:
  - Multi-layer duplicate protection (client lock, server idempotency, database constraints)
  - Toggle functionality with visual feedback
  - Optimistic UI updates
- Share functionality via Web Share API or clipboard
- Direct download of photos to user devices
- Keyboard navigation (arrow keys, escape)
- Integrated commenting on individual memories
- Video format detection (mp4, webm, ogg, mov)
- External platform support (YouTube, Vimeo)

**I. Memorial Events System**
- Event type support:
  - Candlelight Vigil
  - Barbecue/Picnic
  - Block Party
  - Memorial Service
  - Celebration of Life
  - Custom events
- RSVP tracking with attendee count
- Event date and time scheduling
- Location specification
- Email and text notification system
- Memorial-specific event filtering

**J. Saved Memorials System**
- Bookmark functionality for authenticated users
- Relationship categorization:
  - Family, Friend, Colleague
  - Police Officer, Firefighter, Military
  - Teacher, Mentor, Neighbor
  - Acquaintance, Other (with custom field)
- Personal notes field for private documentation
- PostgreSQL persistence with indexed queries

**K. Multi-Faith Spiritual System**
- 21 diverse spiritual symbols:
  - Christianity (Cross variants, Praying Hands, Bible)
  - Islam (Star and Crescent, Mosque)
  - Judaism (Star of David, Menorah)
  - Buddhism (Lotus, Dharma Wheel, Buddha)
  - Hinduism (Om, Ganesha)
  - Sikhism (Khanda)
  - Other traditions (Peace Dove, Infinity)
- Religion field selection
- Symbol customization for memorial pages
- Font family selection
- Theme color customization

**L. Business Partnership Systems**

**Funeral Home Partnership:**
- Partner registration and onboarding
- Referral tracking system
- Commission management (10-15% tiered structure)
- Automated commission calculation
- Payout tracking and management
- Co-branded memorial options
- Performance analytics dashboard

**Flower Shop Partnership:**
- 20% commission model
- Location-based shop discovery
- Sympathy flower ordering interface
- Order tracking system
- Delivery status monitoring
- Commission calculation automation
- Payout record keeping

**M. Memorial Fundraising System**
- Stripe integration for secure payments
- Fundraiser creation with goal setting
- Progress tracking dashboard
- Platform fee configuration (2.5%-5%)
- Expense breakdown transparency:
  - Burial costs
  - Funeral service
  - Headstone
  - Flowers
  - Other (with description field)
- Donation history and analytics
- Anonymous donation option
- Stripe payment ID tracking

**N. Live Streaming System**
- Virtual attendance for memorial services
- Streaming platform support:
  - YouTube
  - Zoom
  - Facebook Live
  - Custom stream URLs
- Scheduled start/end time configuration
- Live status indicator
- Viewer count tracking
- Recording URL for post-event viewing
- Optional password protection
- Viewer tracking with join/leave timestamps
- Duration calculation in minutes

**O. Content Moderation System**
- Server-side profanity filtering
- Inappropriate language detection
- User-generated content screening for:
  - Memorial biographies
  - Condolence messages
  - Comments
  - Memory captions
- Respectful content enforcement

**P. Analytics & Administration**
- Admin dashboard with real-time statistics:
  - Total users and new registrations
  - Total memorials created
  - Fundraiser performance
  - Donation amounts and platform revenue
  - Page views and top-performing pages
  - Support system statistics
  - Partner performance metrics
- Google Analytics integration
- Plausible Analytics (privacy-focused)
- User activity tracking
- Memorial engagement metrics

### 4.3 Technical Foundation

**Progressive Web App (PWA) Architecture:**
- Smart install prompts for mobile devices
- Offline support via service workers
- Asset caching for faster load times
- Standalone mode for app-like experience
- Responsive design for all screen sizes

**Multi-Platform Deployment:**
- Web application (primary)
- iOS mobile app (Capacitor framework)
- Android mobile app (Capacitor framework)
- Future desktop support (Tauri/Electron ready)

**Database Architecture:**
- PostgreSQL (Neon serverless) with 25+ tables
- Drizzle ORM for type-safe queries
- Comprehensive indexing strategy:
  - Memorial creator email + creation date
  - Public/private memorial filtering
  - Hood memorial city/state composite
  - Essential worker category filtering
  - Celebrity memorial profession indexing
  - Prison access request status tracking
  - Scheduled message event date indexing

**Security Implementation:**
- Replit Auth (OpenID Connect) integration
- Session-based authentication with PostgreSQL storage
- Role-based access control (RBAC)
- Protected API routes requiring authentication
- Zod schema validation on all inputs
- CSRF protection
- Lazy-loaded Stripe for PCI compliance
- Audit logging for sensitive operations

---

## 5. DETAILED SYSTEM ARCHITECTURE

### 5.1 Frontend Architecture

**Technology Stack:**
- React 18 with TypeScript for type safety
- Vite for fast development and optimized production builds
- Wouter for lightweight client-side routing
- TanStack Query v5 for server state management
- Tailwind CSS for utility-first styling
- Radix UI primitives for accessible components
- Shadcn/ui component library (30+ reusable components)

**Page Structure (18+ distinct pages):**
1. Home/Landing Page
2. Memorial Creation
3. Memorial View (public/private)
4. Memorial Gallery
5. Celebrity Memorials Browser
6. Celebrity Memorial Creator
7. Essential Workers Memorial Creator
8. Hood Memorials Browser
9. Hood Memorial Creator
10. Neighborhoods Management
11. Future Messages Dashboard
12. Future Messages Creator
13. Funeral Program Creator
14. Funeral Program Viewer
15. Prison Access Request Form
16. Admin Dashboard
17. Partner Registration (Funeral Homes)
18. Partner Registration (Flower Shops)
19. User Profile Settings
20. Privacy Policy
21. Terms of Service

**Component Architecture:**
- Reusable UI primitives (Button, Card, Dialog, Form, Input, etc.)
- Business logic components (ScheduledMessageCard, MemorialCard, etc.)
- Layout components (Header, Sidebar, Footer)
- Form components with react-hook-form integration
- Data display components (Tables, Charts via Recharts)

**State Management:**
- TanStack Query for server state caching
- React Context for theme management
- Local state for UI interactions
- Query invalidation for optimistic updates

### 5.2 Backend Architecture

**Technology Stack:**
- Node.js with TypeScript
- Express.js for RESTful API
- Drizzle ORM for database operations
- OpenID Connect (Replit Auth) for authentication
- Stripe SDK for payment processing
- QRCode library for code generation

**API Endpoint Organization (80+ endpoints across 14 feature areas):**

1. **Authentication & User Management:**
   - POST /api/login
   - POST /api/logout
   - GET /api/auth/user
   - GET /api/callback (OIDC)
   - PUT /api/user/profile
   - DELETE /api/user/account

2. **Memorial Management:**
   - POST /api/memorials
   - GET /api/memorials (public listing)
   - GET /api/memorials/:id
   - PUT /api/memorials/:id
   - DELETE /api/memorials/:id
   - GET /api/memorials/:id/admins
   - POST /api/memorials/:id/admins
   - DELETE /api/memorials/:memorialId/admins/:adminId

3. **QR Code System:**
   - POST /api/qr-codes
   - GET /api/qr-codes/:memorialId
   - GET /api/qr-codes/:id/pdf
   - PUT /api/qr-codes/:id
   - DELETE /api/qr-codes/:id

4. **Memory Gallery:**
   - POST /api/memories
   - GET /api/memories/:memorialId
   - PUT /api/memories/:id
   - DELETE /api/memories/:id
   - POST /api/memories/:id/comments
   - GET /api/memories/:id/comments
   - POST /api/memories/:id/reactions
   - DELETE /api/memories/:memoryId/reactions/:userId

5. **Condolences & Comments:**
   - POST /api/condolences
   - GET /api/condolences/:memorialId
   - POST /api/memorial-comments
   - GET /api/memorial-comments/:memorialId

6. **Saved Memorials:**
   - POST /api/saved-memorials
   - GET /api/saved-memorials (user's saved list)
   - DELETE /api/saved-memorials/:id

7. **Future Messages:**
   - POST /api/scheduled-messages
   - GET /api/scheduled-messages/:memorialId
   - GET /api/scheduled-messages/all (global dashboard)
   - PUT /api/scheduled-messages/:id
   - DELETE /api/scheduled-messages/:id

8. **Fundraising:**
   - POST /api/fundraisers
   - GET /api/fundraisers/:memorialId
   - POST /api/donations
   - GET /api/donations/:fundraiserId
   - POST /api/create-payment-intent (Stripe)

9. **Celebrity Memorials:**
   - POST /api/celebrity-memorials
   - GET /api/celebrity-memorials
   - GET /api/celebrity-memorials/:id
   - POST /api/celebrity-donations
   - POST /api/celebrity-fan-content
   - GET /api/celebrity-fan-content/:celebrityId

10. **Essential Workers:**
    - POST /api/essential-workers
    - GET /api/essential-workers
    - GET /api/essential-workers/:id
    - GET /api/essential-workers/category/:category

11. **Hood Memorials:**
    - POST /api/hood-memorials
    - GET /api/hood-memorials
    - GET /api/hood-memorials/:id
    - POST /api/neighborhoods
    - GET /api/neighborhoods

12. **Prison Access:**
    - GET /api/prison/facilities
    - POST /api/prison/access-requests
    - GET /api/prison/access-requests
    - PUT /api/prison/access-requests/:id/status
    - POST /api/prison/verifications
    - POST /api/prison/payments
    - POST /api/prison/sessions
    - POST /api/prison/sessions/validate

13. **Funeral Programs:**
    - POST /api/funeral-programs
    - GET /api/funeral-programs/:memorialId
    - PUT /api/funeral-programs/:id
    - POST /api/program-items

14. **Business Partnerships:**
    - POST /api/funeral-home-partners
    - GET /api/funeral-home-partners
    - POST /api/partner-referrals
    - POST /api/flower-shop-partners
    - POST /api/flower-orders

**Request Validation:**
- Zod schemas for all POST/PUT requests
- Type inference from Drizzle schemas
- Input sanitization and profanity filtering
- Email format validation
- Required field enforcement

**Error Handling:**
- Structured error responses with HTTP status codes
- Zod validation error formatting
- Database constraint violation handling
- Authentication failure responses
- Rate limiting (implicit via Replit infrastructure)

### 5.3 Database Schema Design

**25+ Database Tables:**

1. **sessions** - Session storage for Replit Auth
2. **users** - User profiles and authentication data
3. **user_settings** - Notification and privacy preferences
4. **memorials** - Core memorial information
5. **memorial_admins** - Multi-user admin access control
6. **qr_codes** - QR code generation and tracking
7. **memories** - Photo/video gallery uploads
8. **memory_comments** - Comments on individual memories
9. **memory_condolences** - Condolences on memories
10. **memory_reactions** - Heart/like reactions on memories
11. **condolences** - General memorial condolences
12. **memorial_likes** - Memorial page likes
13. **memorial_comments** - Threaded comments on memorials
14. **saved_memorials** - User's saved memorial bookmarks
15. **memorial_live_streams** - Live streaming event details
16. **memorial_live_stream_viewers** - Viewer tracking
17. **scheduled_messages** - Future message system
18. **fundraisers** - Memorial fundraising campaigns
19. **donations** - Individual donation records
20. **celebrity_memorials** - Celebrity memorial data
21. **celebrity_donations** - Celebrity memorial donations
22. **celebrity_fan_content** - Estate-controlled exclusive content
23. **grief_support** - Support resources and contacts
24. **legacy_events** - Memorial events and gatherings
25. **music_playlists** - Memorial music selections
26. **essential_workers_memorials** - First responder memorials
27. **hood_memorials** - Neighborhood legend memorials
28. **neighborhoods** - Neighborhood profile management
29. **self_written_obituaries** - Pre-written obituaries
30. **prison_facilities** - Correctional facility directory
31. **prison_access_requests** - Access request management
32. **prison_verifications** - Identity verification records
33. **prison_payments** - Payment transaction tracking
34. **prison_access_sessions** - Active access token management
35. **prison_audit_logs** - Complete audit trail
36. **advertisements** - Ad campaign management
37. **advertisement_sales** - Ad conversion tracking
38. **funeral_home_partners** - Funeral home partnerships
39. **partner_referrals** - Referral tracking
40. **partner_commissions** - Commission calculations
41. **partner_payouts** - Payout records
42. **flower_shop_partners** - Florist partnerships
43. **flower_orders** - Flower order management
44. **flower_commissions** - Florist commission tracking
45. **flower_payouts** - Florist payout records
46. **funeral_programs** - Digital funeral programs
47. **program_items** - Individual program elements
48. **push_tokens** - Mobile push notification tokens
49. **page_views** - Analytics page view tracking
50. **analytics_events** - Custom event tracking

**Indexing Strategy:**
- Primary keys on all tables (UUID or serial)
- Foreign key relationships with cascade delete
- Composite indexes for common query patterns:
  - (city, state) for hood_memorials and neighborhoods
  - (memorialId, userId) for reactions and saved memorials
  - (category) for essential_workers_memorials
  - (status) for prison_access_requests
  - (eventDate) for scheduled_messages
- Unique constraints for data integrity:
  - Email uniqueness in users table
  - Invite code uniqueness in memorials
  - One-to-one relationships (user_settings, music_playlists)

**Data Types:**
- VARCHAR for IDs (UUID generation via gen_random_uuid())
- TEXT for variable-length strings (bios, descriptions)
- TIMESTAMP for date/time tracking
- BOOLEAN for flags and toggles
- DECIMAL for monetary values (precision: 10, scale: 2)
- JSON/JSONB for structured data (achievements, awards, contacts)
- Arrays for lists (certification arrays, attachment URLs)

---

## 6. NOVEL FEATURES AND CLAIMS

### Claim 1: Dynamic QR Code System for Physical-Digital Memorial Integration

**A method for linking physical memorial sites to dynamically updating digital content, comprising:**

(a) Generating a machine-readable code (QR code) associated with a unique memorial identifier stored in a database;

(b) Encoding within said machine-readable code a URL that resolves to a server endpoint, wherein said endpoint accepts the memorial identifier as a parameter;

(c) Configuring said server endpoint to perform one of three operations based on a "purpose" field associated with the code:
   - "tombstone" mode: Redirect to an upload interface allowing anonymous users to contribute photos/videos to the memorial
   - "view" mode: Redirect to a public memorial page displaying aggregated content
   - "general" mode: Redirect to a general upload interface for memorial card recipients

(d) Storing all user-contributed content in a centralized database linked to the memorial identifier;

(e) Wherein said machine-readable code continues to function without modification as families add new content over time, because the code links to a dynamic endpoint rather than static content;

(f) Generating a printable PDF document containing said machine-readable code with decorative branding elements (purple/gold color scheme, platform tagline);

(g) Providing weather-resistant printing specifications suitable for outdoor placement on tombstones and memorial markers.

**Claims 1.1-1.5: Variations on QR code purpose modes, PDF generation, continuous update mechanism, and cemetery visitor upload workflow**

### Claim 2: Prison Access Control System with Time-Limited Tokens and Audit Logging

**A method for providing secure, monitored access to digital memorial content for incarcerated individuals, comprising:**

(a) Receiving an access request containing:
   - Memorial identifier
   - Correctional facility identifier
   - Inmate identification data (first name, last name, DOC number)
   - Relationship to deceased person
   - Proof of relationship documentation URL

(b) Storing said access request in a database with status field set to "pending";

(c) Initiating an identity verification workflow specific to correctional facility protocols;

(d) Upon verification approval, generating payment instructions compatible with correctional facility payment systems including:
   - ConnectNetwork/GTL integration
   - ViaPath Technologies integration
   - Securus Technologies integration

(e) Upon payment confirmation, generating a time-limited access token with the following properties:
   - Unique token string
   - Associated memorial identifier
   - Expiration timestamp (configurable duration)
   - "isActive" boolean flag
   - Last accessed timestamp

(f) Validating token on each memorial page request by:
   - Checking token string matches database record
   - Verifying isActive flag is true
   - Confirming current time is before expiration timestamp
   - Updating "lastAccessedAt" field in database

(g) Creating audit log entries for all actions including:
   - Request creation
   - Status changes
   - Token validation attempts
   - Session start and end events
   - Recording IP address and user agent for security

(h) Automatically deactivating tokens upon expiration or manual termination;

(i) Calculating usage fees based on session duration (e.g., $0.15 per minute).

**Claims 2.1-2.7: Variations on verification workflows, payment integration methods, token expiration logic, audit logging specificity, and pricing models**

### Claim 3: Future Message Delivery System with Recurrence Patterns

**A method for scheduling legacy messages from deceased individuals to be delivered on future dates, comprising:**

(a) Receiving message creation data including:
   - Memorial identifier linking to deceased person
   - Recipient name and optional email address
   - Event type selection from predefined categories (birthday, graduation, wedding, anniversary, holidays, custom)
   - Scheduled delivery date
   - Delivery time in HH:MM format
   - Message text content
   - Optional media attachment URLs (photos, videos, documents)

(b) Supporting recurrence pattern specification:
   - "yearly" for annual delivery (e.g., every birthday)
   - "monthly" for monthly delivery
   - "custom" for user-defined intervals

(c) Storing message in database with status "draft" or "pending";

(d) Implementing a scheduled task system that:
   - Queries database daily for messages with eventDate matching current date
   - Filters for sendTime matching current time
   - Checks status is "pending" and isSent is false

(e) Upon scheduled time match:
   - Sending email to recipient's email address if provided
   - Including message text and media attachments
   - Updating message status to "sent"
   - Setting isSent flag to true
   - Recording sentAt timestamp

(f) For recurring messages:
   - NOT setting isSent to true
   - Calculating next delivery date based on recurrence interval
   - Updating eventDate to next occurrence
   - Maintaining status as "pending"

(g) Providing a global dashboard interface displaying:
   - All scheduled messages across all user memorials
   - Filter options: Upcoming, Next 7 Days, Next 30 Days, Drafts, Sent
   - Statistics: Messages in next 7 days, next 30 days, total upcoming

(h) Offering 60+ pre-written message templates categorized by event type.

**Claims 3.1-3.6: Variations on recurrence logic, template systems, delivery mechanisms, failure handling, and cross-memorial management**

### Claim 4: Neighborhood Memorial System with Geographic Indexing

**A method for creating community-based memorial walls for local legends, comprising:**

(a) Establishing neighborhood profile entities with attributes:
   - Neighborhood name
   - Geographic coordinates (latitude, longitude)
   - City and state
   - Logo/branding image URL
   - Historical information and founding details
   - Population statistics
   - Founder information

(b) Creating memorial entities linked to neighborhood profiles, including:
   - Standard memorial data (name, dates, biography)
   - Neighborhood-specific fields:
     * Neighborhood name and logo reference
     * Club affiliation and club logo
     * "Known for" highlights describing local impact
     * Community impact description
     * Legacy documentation

(c) Requiring authenticated user creation to prevent spam;

(d) Automatically associating creator email from authenticated session;

(e) Implementing composite database index on (city, state) columns for efficient geographic queries;

(f) Providing search and filter capabilities:
   - Search by city name
   - Search by state
   - Search by neighborhood name
   - Filter by creation date

(g) Displaying neighborhood statistics including:
   - Total memorials count
   - Neighborhood founding year
   - Historical significance markers

**Claims 4.1-4.4: Variations on geographic search algorithms, neighborhood profile management, creator verification, and community impact metrics**

### Claim 5: Celebrity Memorial System with Estate-Controlled Fan Content

**A method for creating verified celebrity memorials with exclusive content distribution, comprising:**

(a) Implementing a 4-step wizard interface for celebrity memorial creation:
   - Step 1: Basic information (name, profession category, sub-profession, dates, biography)
   - Step 2: Charity integration (charity name, donation amount per tribute, platform percentage)
   - Step 3: Achievements and awards (structured data entry with titles, years, descriptions)
   - Step 4: Family/legal verification (relationship declaration, document upload)

(b) Profession categorization system with 10 primary categories:
   - Sports (with sub-categories: Baseball, Basketball, Football, Soccer, Tennis, Golf, etc.)
   - Actors/Actresses (Film, Television, Theatre, Voice Acting)
   - Musicians (Pop, Rock, Classical, Jazz, Hip-Hop, Country, etc.)
   - Royalty, Politicians, Authors, Activists
   - Business Leaders, Scientists/Inventors, Religious Leaders

(c) Verification workflow:
   - Setting initial status to "pending"
   - Admin review of submitted documentation
   - Status transition to "approved" or "rejected"
   - Recording verifier identity and verification timestamp

(d) Estate-controlled fan content platform:
   - Restricting content creation to admin users only
   - Supporting four content types: video messages, photos, videos, audio messages
   - Implementing draft/published status workflow
   - Tracking view counts for each content item
   - Preventing public comments to maintain content integrity

(e) Applying higher platform fee (5%) for celebrity memorial donations compared to standard memorials (3%);

(f) Transparent donation tracking showing:
   - Total donation amount
   - Charity portion calculation
   - Platform portion calculation
   - Stripe payment ID for transaction verification

**Claims 5.1-5.6: Variations on verification document types, profession sub-categorization, content approval workflows, revenue split calculations, and estate authentication**

### Claim 6: Essential Worker Memorial System with Category-Specific Professional Details

**A method for creating memorials honoring first responders and essential workers with profession-specific data fields, comprising:**

(a) Defining primary categories:
   - Police Officers
   - Firefighters
   - Healthcare Workers
   - Military Personnel
   - Teachers
   - EMTs/Paramedics

(b) Implementing conditional field display based on selected category:

   For Police Officers:
   - Badge number
   - Precinct/district
   - Rank (Officer, Sergeant, Lieutenant, Captain, etc.)
   - Years of service
   - Line-of-duty death boolean

   For Firefighters:
   - Station number/name
   - Badge number
   - Rank (Firefighter, Lieutenant, Captain, Chief)
   - Years of service
   - Line-of-duty death boolean

   For Healthcare Workers:
   - Hospital/facility unit
   - Specialization (Emergency Medicine, ICU, Cardiology, etc.)
   - Professional certifications array
   - Years of service

   For Military Personnel:
   - Service branch (Army, Navy, Air Force, Marines, Coast Guard, Space Force)
   - Rank (following military rank structure)
   - Unit assignment
   - Deployment history (structured array of: location, years, campaign name)
   - Years of service
   - Combat/non-combat death designation

(c) Honors and awards system:
   - Structured JSON array storing: award name, year received, description
   - Support for military medals (Purple Heart, Bronze Star, etc.)
   - Professional commendations
   - Community service awards

(d) Database indexing on category field for efficient filtering;

(e) Public/private toggle with default to public for these memorials;

(f) Display rendering showing category-appropriate badges and insignia.

**Claims 6.1-6.5: Variations on category-specific field sets, honor/award structures, deployment tracking, certification management, and line-of-duty designation systems**

### Claim 7: Funeral Program System with Bluetooth Audio Synchronization

**A method for creating digital funeral programs with synchronized audio playback, comprising:**

(a) Program creation interface accepting:
   - Service information (location, date, time)
   - Deceased person details
   - Order of service items (customizable sequence)
   - Background music URL for program-level audio
   - Theme color selection
   - Cover image upload
   - Family information
   - Special thanks acknowledgments
   - Repast location details

(b) Individual program item data structure:
   - Item type (reading, eulogy, hymn, prayer, musical selection, processional, recessional)
   - Title/name of item
   - Performer/speaker name
   - Optional item-specific audio clip URL
   - Order/sequence number

(c) Bluetooth connectivity system:
   - Boolean flag "enableBluetoothAudio" to activate/deactivate
   - Text field "bluetoothDeviceName" for device pairing specification
   - Instructions for connecting to wireless speakers

(d) Audio playback control interface:
   - Play/pause controls for background music
   - Individual play buttons for each program item's audio
   - Volume control
   - Bluetooth connection status indicator

(e) Synchronized timing coordination:
   - Triggering item-specific audio when program element begins
   - Auto-advancing to next item upon audio completion (optional)
   - Manual override controls for program coordinators

(f) PDF export functionality for printed program generation;

(g) Digital distribution via QR code or URL link sharing.

**Claims 7.1-7.4: Variations on audio synchronization algorithms, Bluetooth pairing protocols, multi-speaker support, and program timing coordination**

### Claim 8: Integrated Business Partnership Commission System

**A method for managing B2B partnerships with automated commission calculation, comprising:**

(a) Funeral home partnership system:
   - Partner registration with contact details and credentials
   - Tiered commission structure (10% base, 15% for high-volume partners)
   - Referral tracking via unique referral codes
   - Memorial creation attribution to referring partner
   - Automated commission calculation upon memorial creation or donation
   - Payout tracking with status (pending, processing, completed)
   - Performance dashboard showing referral count and revenue generated

(b) Flower shop partnership system:
   - Partner registration with shop location data
   - Fixed 20% commission rate on all orders
   - Location-based shop discovery (search by city/state)
   - Order placement interface integrated into memorial pages
   - Order status tracking (pending, confirmed, delivered)
   - Commission auto-calculation: (order amount × 0.20)
   - Payout aggregation and disbursement tracking

(c) Advertisement partnership system:
   - Business advertisement submission interface
   - Category selection (funeral services, flowers, monuments, grief counseling, etc.)
   - Pricing model configuration
   - Admin approval workflow
   - Placement on relevant memorial pages
   - Impression and click tracking
   - Performance analytics reporting

(d) Unified partner portal providing:
   - Dashboard with revenue metrics
   - Commission history
   - Payout status
   - Referral/order activity
   - Account settings

**Claims 8.1-8.5: Variations on commission calculation algorithms, tiered partnership levels, geographic service area matching, payout frequency, and analytics reporting**

### Claim 9: Multi-Faith Spiritual Customization System

**A method for honoring diverse spiritual traditions through memorial customization, comprising:**

(a) Providing a library of 21 spiritual symbols representing:

   Christianity:
   - Cross (traditional and variants)
   - Praying Hands
   - Bible
   - Ichthys (fish symbol)

   Islam:
   - Star and Crescent
   - Mosque
   - Calligraphy

   Judaism:
   - Star of David
   - Menorah
   - Torah Scroll

   Buddhism:
   - Lotus Flower
   - Dharma Wheel
   - Buddha figure

   Hinduism:
   - Om symbol
   - Ganesha

   Sikhism:
   - Khanda

   Other traditions:
   - Peace Dove
   - Infinity symbol
   - Tree of Life
   - Yin Yang

(b) Symbol selection interface during memorial creation;

(c) Storing selected symbol identifier in memorial database record;

(d) Rendering selected symbol on:
   - Memorial page header
   - QR code PDF documents
   - Funeral program covers
   - Share images

(e) Religion field for textual denomination storage;

(f) Theme color customization with faith-appropriate color palettes;

(g) Font selection for memorial text display;

(h) Respectful default styling (purple/gold color scheme) if no selection made.

**Claims 9.1-9.3: Variations on symbol libraries, rendering placements, and cultural sensitivity in design**

### Claim 10: Live Streaming System with Viewer Tracking

**A method for enabling virtual attendance at memorial services with engagement tracking, comprising:**

(a) Creating live stream event records containing:
   - Memorial identifier
   - Stream title and description
   - Stream URL (YouTube, Zoom, Facebook Live, or custom)
   - Stream type identifier
   - Scheduled start and end timestamps
   - Live status boolean (true when currently streaming)
   - Initial viewer count of zero
   - Optional recording URL for post-event viewing
   - Public/private toggle
   - Optional password protection

(b) Viewer tracking system:
   - Recording viewer join events with timestamp
   - Capturing viewer name (authenticated users or guest names)
   - Optional email capture
   - Recording viewer leave events with timestamp
   - Calculating duration in minutes: (leftAt - joinedAt)

(c) Real-time viewer count updates:
   - Incrementing count on join events
   - Decrementing count on leave events
   - Displaying current viewer count on memorial page

(d) Post-event analytics:
   - Total unique viewers
   - Peak concurrent viewers
   - Average viewing duration
   - Viewer list with join/leave times

(e) Password protection workflow for private streams:
   - Requiring password input before displaying stream URL
   - Storing hashed password in database
   - Validating password on access attempt

(f) Recording availability:
   - Allowing admin to upload recording URL after event
   - Displaying recording for those who missed live event
   - Tracking recording views separately from live views

**Claims 10.1-10.5: Variations on viewer authentication, concurrent viewer calculations, multi-platform stream integration, and recording distribution**

---

## 7. TECHNICAL IMPLEMENTATION DETAILS

### 7.1 Frontend Technology Specifications

**React Component Architecture:**
```typescript
// Example: Scheduled Message Management
interface ScheduledMessage {
  id: string;
  memorialId: string;
  recipientName: string;
  recipientEmail: string | null;
  eventType: string;
  customEventName: string | null;
  eventDate: string | null;
  sendTime: string;
  message: string;
  mediaUrl: string | null;
  isRecurring: boolean;
  recurrenceInterval: string | null;
  status: 'draft' | 'pending' | 'sent' | 'failed';
  isSent: boolean;
  sentAt: string | null;
  createdAt: string;
}

// TanStack Query implementation
const { data: messages, isLoading } = useQuery({
  queryKey: ['/api/scheduled-messages', memorialId],
  enabled: !!memorialId
});

// Form validation with Zod
const messageSchema = z.object({
  recipientName: z.string().min(1, "Required"),
  recipientEmail: z.string().email("Valid email required"),
  eventType: z.string(),
  eventDate: z.string(),
  message: z.string().min(10),
  isRecurring: z.boolean(),
  recurrenceInterval: z.string().optional()
});
```

**PWA Configuration:**
```javascript
// Service Worker for offline support
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open('opictuary-v1').then((cache) => {
      return cache.addAll([
        '/',
        '/index.html',
        '/styles.css',
        '/app.js',
        '/manifest.json'
      ]);
    })
  );
});

// Manifest.json for app installation
{
  "name": "Opictuary - Digital Memorial Platform",
  "short_name": "Opictuary",
  "description": "Preserving Memories. Honoring Lives.",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a0033",
  "theme_color": "#9333ea",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

### 7.2 Backend API Implementation

**Express.js Route Handler Example:**
```typescript
// Prison Access Request Creation
app.post("/api/prison/access-requests", async (req, res) => {
  try {
    // Validate input with Zod
    const validated = insertPrisonAccessRequestSchema.parse(req.body);
    
    // Create access request
    const request = await storage.createPrisonAccessRequest({
      ...validated,
      status: "pending"
    });
    
    // Create audit log entry
    await storage.createPrisonAuditLog({
      requestId: request.id,
      action: "request_created",
      performedBy: validated.requestedByEmail,
      ipAddress: req.ip,
      userAgent: req.get('user-agent'),
      metadata: { requestData: validated }
    });
    
    // Send confirmation email with payment instructions
    // (Implementation uses third-party email service)
    
    res.status(201).json(request);
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({ errors: error.errors });
    }
    res.status(500).json({ message: "Failed to create request" });
  }
});

// Token Validation with Expiration Check
app.post("/api/prison/sessions/validate", async (req, res) => {
  try {
    const { token } = req.body;
    
    const session = await storage.validatePrisonAccessToken(token);
    
    if (!session) {
      await storage.createPrisonAuditLog({
        sessionId: null,
        action: "token_validation_failed",
        performedBy: "system",
        ipAddress: req.ip,
        metadata: { reason: "invalid_or_expired" }
      });
      return res.status(401).json({ valid: false });
    }
    
    await storage.createPrisonAuditLog({
      sessionId: session.id,
      action: "token_validated",
      performedBy: "system",
      ipAddress: req.ip
    });
    
    res.json({ valid: true, session });
  } catch (error) {
    res.status(500).json({ message: "Validation error" });
  }
});
```

**QR Code Generation:**
```typescript
import QRCode from 'qrcode';
import { PDFDocument, rgb } from 'pdf-lib';

async function generateQRCodePDF(memorial: Memorial, code: QRCodeData) {
  // Generate QR code as data URL
  const qrDataUrl = await QRCode.toDataURL(code.code, {
    width: 300,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  });
  
  // Create PDF document
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([600, 800]);
  
  // Add purple background (280° hue)
  page.drawRectangle({
    x: 0,
    y: 0,
    width: 600,
    height: 800,
    color: rgb(0.58, 0.20, 0.93) // Rich purple
  });
  
  // Embed QR code image
  const qrImage = await pdfDoc.embedPng(qrDataUrl);
  page.drawImage(qrImage, {
    x: 150,
    y: 400,
    width: 300,
    height: 300
  });
  
  // Add text: "Preserving Memories. Honoring Lives."
  page.drawText('Preserving Memories. Honoring Lives.', {
    x: 150,
    y: 350,
    size: 16,
    color: rgb(0.85, 0.65, 0.13) // Gold accent
  });
  
  // Add memorial name
  page.drawText(memorial.name, {
    x: 200,
    y: 600,
    size: 24,
    color: rgb(1, 1, 1)
  });
  
  // Add scanning instructions
  page.drawText('Scan to view memorial and upload memories', {
    x: 150,
    y: 300,
    size: 12,
    color: rgb(1, 1, 1)
  });
  
  return pdfDoc.save();
}
```

### 7.3 Database Query Optimization

**Drizzle ORM Implementation:**
```typescript
// Efficient hood memorial search with composite index
async function searchHoodMemorials(city: string, state: string) {
  return await db
    .select()
    .from(hoodMemorials)
    .where(
      and(
        eq(hoodMemorials.city, city),
        eq(hoodMemorials.state, state)
      )
    )
    .orderBy(desc(hoodMemorials.createdAt))
    .limit(50);
  // Uses composite index: idx_hood_memorials_city_state
}

// Future messages dashboard with multiple filters
async function getFutureMessagesDashboard(
  filter: 'upcoming' | 'next7days' | 'drafts' | 'sent'
) {
  const now = new Date();
  const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
  
  let query = db.select().from(scheduledMessages);
  
  switch (filter) {
    case 'upcoming':
      query = query.where(
        and(
          eq(scheduledMessages.status, 'pending'),
          gte(scheduledMessages.eventDate, now.toISOString())
        )
      );
      break;
    case 'next7days':
      query = query.where(
        and(
          eq(scheduledMessages.status, 'pending'),
          between(
            scheduledMessages.eventDate,
            now.toISOString(),
            sevenDaysFromNow.toISOString()
          )
        )
      );
      break;
    case 'drafts':
      query = query.where(eq(scheduledMessages.status, 'draft'));
      break;
    case 'sent':
      query = query.where(eq(scheduledMessages.isSent, true));
      break;
  }
  
  return await query.orderBy(asc(scheduledMessages.eventDate));
  // Uses index: idx_scheduled_messages_event_date
}

// Prison access audit log creation
async function createPrisonAuditLog(log: InsertPrisonAuditLog) {
  return await db
    .insert(prisonAuditLogs)
    .values({
      ...log,
      metadata: log.metadata as any, // JSONB type
      createdAt: new Date()
    })
    .returning();
}
```

### 7.4 Authentication & Security Implementation

**Replit OIDC Integration:**
```typescript
import { Strategy } from '@replit/passport-oidc';
import passport from 'passport';
import session from 'express-session';
import connectPg from 'connect-pg-simple';

// Session configuration
const sessionStore = new (connectPg(session))({
  conString: process.env.DATABASE_URL,
  createTableIfMissing: true,
  ttl: 7 * 24 * 60 * 60 * 1000, // 1 week
  tableName: 'sessions'
});

app.use(session({
  secret: process.env.SESSION_SECRET!,
  store: sessionStore,
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 7 * 24 * 60 * 60 * 1000
  }
}));

// OIDC Strategy
const strategy = new Strategy({
  config: await getOidcConfig(),
  scope: 'openid email profile offline_access',
  callbackURL: `https://${domain}/api/callback`
}, async (tokens, verified) => {
  const claims = tokens.claims();
  
  // Upsert user in database
  await db.insert(users)
    .values({
      id: claims.sub,
      email: claims.email,
      firstName: claims.first_name,
      lastName: claims.last_name,
      profileImageUrl: claims.profile_image_url
    })
    .onConflictDoUpdate({
      target: users.id,
      set: {
        email: claims.email,
        updatedAt: new Date()
      }
    });
  
  verified(null, { claims, tokens });
});

// Authentication middleware
const isAuthenticated: RequestHandler = async (req, res, next) => {
  if (!req.isAuthenticated()) {
    return res.status(401).json({ message: "Unauthorized" });
  }
  
  const user = req.user as any;
  const now = Math.floor(Date.now() / 1000);
  
  // Check token expiration
  if (now > user.expires_at) {
    // Attempt token refresh
    try {
      const config = await getOidcConfig();
      const newTokens = await refreshTokenGrant(
        config,
        user.refresh_token
      );
      updateUserSession(user, newTokens);
    } catch {
      return res.status(401).json({ message: "Session expired" });
    }
  }
  
  next();
};

// Admin authorization middleware
const isAdmin: RequestHandler = async (req, res, next) => {
  if (!req.isAuthenticated()) {
    return res.status(401).json({ message: "Unauthorized" });
  }
  
  const userId = (req.user as any).claims.sub;
  const dbUser = await db
    .select()
    .from(users)
    .where(eq(users.id, userId))
    .limit(1);
  
  if (!dbUser[0] || !dbUser[0].isAdmin) {
    return res.status(403).json({ message: "Forbidden" });
  }
  
  next();
};
```

**Content Moderation:**
```typescript
// Server-side profanity filter
const inappropriateWords = [
  // List of filtered terms
];

function moderateContent(text: string): { 
  isClean: boolean; 
  flaggedWords: string[]; 
} {
  const lowerText = text.toLowerCase();
  const flagged: string[] = [];
  
  for (const word of inappropriateWords) {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    if (regex.test(lowerText)) {
      flagged.push(word);
    }
  }
  
  return {
    isClean: flagged.length === 0,
    flaggedWords: flagged
  };
}

// Apply to user-generated content
app.post("/api/memories", isAuthenticated, async (req, res) => {
  const { caption, ...data } = req.body;
  
  const moderation = moderateContent(caption);
  if (!moderation.isClean) {
    return res.status(400).json({
      message: "Content contains inappropriate language",
      flaggedWords: moderation.flaggedWords
    });
  }
  
  // Proceed with memory creation
  const memory = await storage.createMemory({
    caption,
    ...data
  });
  
  res.status(201).json(memory);
});
```

### 7.5 Payment Processing with Stripe

**Stripe Integration:**
```typescript
import Stripe from 'stripe';

// Lazy-load Stripe for PCI compliance
const getStripe = () => {
  if (!process.env.STRIPE_SECRET_KEY) {
    throw new Error("Stripe key not configured");
  }
  return new Stripe(process.env.STRIPE_SECRET_KEY, {
    apiVersion: '2023-10-16'
  });
};

// Create payment intent for donations
app.post("/api/create-payment-intent", isAuthenticated, async (req, res) => {
  try {
    const { amount, fundraiserId, platformFeePercentage } = req.body;
    
    // Calculate platform fee
    const platformFeeAmount = (amount * platformFeePercentage) / 100;
    const netAmount = amount - platformFeeAmount;
    
    const stripe = getStripe();
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // Convert to cents
      currency: 'usd',
      metadata: {
        fundraiserId,
        platformFee: platformFeeAmount.toFixed(2)
      }
    });
    
    res.json({ clientSecret: paymentIntent.client_secret });
  } catch (error) {
    res.status(500).json({ message: "Payment intent creation failed" });
  }
});

// Webhook for payment confirmation
app.post("/api/stripe-webhook", async (req, res) => {
  const signature = req.headers['stripe-signature']!;
  const stripe = getStripe();
  
  try {
    const event = stripe.webhooks.constructEvent(
      req.body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
    
    if (event.type === 'payment_intent.succeeded') {
      const paymentIntent = event.data.object;
      const { fundraiserId, platformFee } = paymentIntent.metadata;
      
      // Record donation in database
      await db.insert(donations).values({
        fundraiserId,
        amount: (paymentIntent.amount / 100).toString(),
        platformFeeAmount: platformFee,
        stripePaymentId: paymentIntent.id,
        donorName: paymentIntent.billing_details?.name || 'Anonymous'
      });
      
      // Update fundraiser current amount
      await db
        .update(fundraisers)
        .set({
          currentAmount: sql`${fundraisers.currentAmount} + ${paymentIntent.amount / 100}`
        })
        .where(eq(fundraisers.id, fundraiserId));
    }
    
    res.json({ received: true });
  } catch (error) {
    res.status(400).send(`Webhook Error: ${error.message}`);
  }
});
```

---

## 8. BUSINESS MODEL

### 8.1 Revenue Streams

**1. Platform Transaction Fees:**
- Standard memorial fundraisers: 3.0% of donation amount
- Celebrity memorial donations: 5.0% of donation amount
- Configurable fee structure (2.5%-5.0% range)
- Example: $1,000 donation = $30 platform revenue (standard) or $50 (celebrity)

**2. Business Partnership Commissions:**

**Funeral Home Partnerships:**
- Tiered commission structure:
  - Basic tier (0-10 referrals/month): 10% per memorial created
  - Premium tier (11+ referrals/month): 15% per memorial created
- Referral tracking via unique partner codes
- Co-branded memorial pages option
- Example: Memorial with $2,000 fundraiser = $200-$300 commission

**Flower Shop Partnerships:**
- Fixed 20% commission on all flower orders
- Location-based matching algorithm
- Order tracking and delivery confirmation
- Example: $150 flower arrangement = $30 platform commission

**3. Prison Access Services:**
- Per-minute pricing: $0.15/minute
- Integration fees with correctional facility payment systems:
  - ConnectNetwork/GTL: Processing fee included
  - ViaPath Technologies: Processing fee included
  - Securus Technologies: Processing fee included
- Average session duration: 30 minutes = $4.50 revenue
- Verification service fee: $25 per access request

**4. Advertisement Platform:**
- Memorial page sidebar placements
- Respectful, category-appropriate ads:
  - Funeral services
  - Monument companies
  - Flower shops
  - Grief counseling services
  - Memorial merchandise
- Pricing structure:
  - Cost-per-impression (CPM): $5-$15 per 1,000 impressions
  - Cost-per-click (CPC): $0.50-$2.00 per click
  - Monthly sponsorship packages: $500-$2,000/month

**5. Merchandise Referrals:**
- Commission on referrals to external merchandise services:
  - Memorial jewelry: 15% commission
  - Custom urns: 10% commission
  - Memorial books: 20% commission
  - Tribute videos: 25% commission

### 8.2 Customer Segments

**B2C (Business-to-Consumer):**
1. **Grieving Families:** Primary users creating memorials for loved ones
2. **Memorial Visitors:** Friends, extended family, community members viewing and contributing
3. **Incarcerated Individuals:** Requesting access to view deceased loved ones' memorials
4. **Self-Planners:** Individuals pre-creating their own memorials and final messages

**B2B (Business-to-Business):**
1. **Funeral Homes:** Partnering to offer digital memorials as part of service packages
2. **Florists:** Local shops providing sympathy flower delivery
3. **Monument Companies:** Advertising tombstones and memorial markers
4. **Grief Counselors:** Offering services to bereaved families
5. **Correctional Facilities:** Contracting for prison access services

### 8.3 Pricing Strategy

**Free Tier:**
- Memorial creation with basic features
- Photo/video gallery (unlimited uploads)
- QR code generation
- Public memorial page
- Basic spiritual symbol selection
- Standard future messages

**Premium Features (Revenue Generators):**
- Fundraising capability (3-5% platform fee)
- Prison access services ($0.15/min + $25 verification)
- Flower delivery orders (20% commission included in price)
- Merchandise purchases (commission included in price)
- Featured memorial placement in search results ($50/month)
- Custom domain for memorial ($10/month)

### 8.4 Market Opportunity

**Total Addressable Market (TAM):**
- United States deaths per year: ~3.4 million
- Global deaths per year: ~60 million
- Prison population (US): ~1.9 million individuals
- Funeral service industry (US): $20 billion annually
- Online memorial market: Growing at 15% CAGR

**Serviceable Addressable Market (SAM):**
- Digitally-connected families: ~70% of US deaths = 2.38 million/year
- Prison access market: 1.9M inmates × 10% memorial access rate = 190,000 potential users
- Funeral home digital adoption: ~50% of 19,000 US funeral homes = 9,500 potential partners

**Serviceable Obtainable Market (SOM) - Year 1:**
- Target: 0.5% market penetration = 11,900 memorials
- Average revenue per memorial:
  - Fundraising: 30% use feature × $1,500 avg × 3% fee = $13.50
  - Prison access: 2% use feature × $50 avg = $1.00
  - Partnerships: 15% conversion × $100 avg commission = $15.00
  - **Total: $29.50 per memorial**
- **Year 1 Revenue Projection: $351,000**

**Growth Projections:**
- Year 2: 2% market penetration = $1.4M revenue
- Year 3: 5% market penetration = $3.5M revenue
- Year 5: 15% market penetration = $10.5M revenue

### 8.5 Competitive Advantages

1. **Physical-Digital Integration:** Only platform with dynamic QR codes for tombstones
2. **Prison Access Specialization:** First memorial platform designed for correctional facility integration
3. **Future Messages:** Unique temporal messaging system with recurrence patterns
4. **Community Focus:** Hood Memorials feature creates local memorial networks
5. **Multi-Faith Respect:** 21 spiritual symbols honoring diverse traditions
6. **Comprehensive Ecosystem:** Integrated fundraising, events, flowers, and funeral programs
7. **Security & Privacy:** Enterprise-grade authentication and audit logging
8. **Mobile-First PWA:** Offline-capable, installable app experience

---

## 9. DATABASE ARCHITECTURE

### 9.1 Entity Relationship Overview

**Core Entities:**
- Users (authentication, profiles)
- Memorials (primary content entity)
- Memorial Admins (multi-user access control)
- QR Codes (physical-digital bridge)
- Memories (photo/video gallery)
- Scheduled Messages (future message delivery)

**Specialized Memorial Types:**
- Celebrity Memorials (verified public figures)
- Essential Workers Memorials (first responders)
- Hood Memorials (neighborhood legends)
- Self-Written Obituaries (pre-planned memorials)

**Supporting Entities:**
- Condolences, Comments, Reactions (social engagement)
- Fundraisers & Donations (financial transactions)
- Live Streams & Viewers (virtual attendance)
- Legacy Events (memorial gatherings)
- Funeral Programs & Items (service planning)

**Business Entities:**
- Funeral Home Partners, Referrals, Commissions, Payouts
- Flower Shop Partners, Orders, Commissions, Payouts
- Advertisements, Sales

**Prison Access Entities:**
- Prison Facilities (directory)
- Access Requests (application workflow)
- Verifications (identity confirmation)
- Payments (transaction records)
- Access Sessions (active tokens)
- Audit Logs (security tracking)

**System Entities:**
- Sessions (authentication storage)
- User Settings (preferences)
- Push Tokens (mobile notifications)
- Page Views, Analytics Events (tracking)

### 9.2 Key Database Indexes

**Performance-Critical Indexes:**
1. `idx_memorials_creator_email` - User's memorial listing
2. `idx_memorials_is_public` - Public memorial discovery
3. `idx_hood_memorials_city_state` - Geographic search (composite)
4. `idx_essential_workers_category` - Category filtering
5. `idx_scheduled_messages_event_date` - Date-based queries
6. `idx_prison_access_requests_status` - Workflow filtering
7. `idx_celebrity_fan_content_memorial_id` - Content retrieval
8. `idx_memory_reactions_memory_id` - Reaction counting
9. `idx_donations_fundraiser_id` - Donation aggregation
10. `idx_memorial_live_streams_start_time` - Upcoming events

**Unique Constraints:**
- Users: email (prevents duplicate accounts)
- Memorials: inviteCode (secure private access)
- Memory Reactions: (memoryId, userId, userEmail) - prevents duplicate likes
- Prison Facilities: facilityCode (unique identification)

### 9.3 Data Integrity Measures

**Foreign Key Cascades:**
- Memorial deletion → Cascade delete memories, comments, QR codes
- User deletion → Cascade delete settings, saved memorials
- Fundraiser deletion → Cascade delete donations
- Memorial deletion → Cascade delete scheduled messages

**Referential Integrity:**
- All memorialId fields reference memorials.id
- All userId fields reference users.id  
- All fundraiserId fields reference fundraisers.id
- Prison access entities maintain referential chain

**JSON Schema Validation:**
- Achievements array in celebrity memorials
- Awards array in celebrity memorials
- Deployments array in military memorials
- Expense breakdown in fundraisers
- Verification documents array

---

## 10. SECURITY AND PRIVACY SYSTEMS

### 10.1 Authentication Security

**Session Management:**
- PostgreSQL-backed session storage (not in-memory)
- 7-day session timeout
- Secure cookie configuration:
  - httpOnly: true (prevents XSS access)
  - secure: true (HTTPS only)
  - sameSite: 'lax' (CSRF protection)
- Automatic session cleanup of expired records

**Token Refresh:**
- OIDC refresh token support
- Automatic token renewal before expiration
- Graceful session expiration handling
- Logout invalidates session immediately

**Password Security:**
- No password storage (delegated to Replit Auth)
- OAuth 2.0 + OpenID Connect flow
- Offline access scope for long-lived sessions

### 10.2 Authorization & Access Control

**Role-Based Permissions:**
- Admin users: Platform-wide access
- Memorial creators: Full control over their memorials
- Memorial admins: Delegated permissions (manage QR, edit memorial, approve content)
- Authenticated users: Create memorials, save memorials, comment
- Guest users: View public memorials, leave condolences

**Memorial Privacy:**
- Public memorials: Discoverable by anyone
- Private memorials: Require invite code for access
- Invite code validation on each request
- Creator email auto-set from authenticated session

**Protected Routes:**
- All creation endpoints require authentication
- Admin endpoints verify isAdmin flag
- Memorial editing requires creator or admin ownership
- QR code management requires specific permission flag

### 10.3 Input Validation & Sanitization

**Zod Schema Validation:**
```typescript
// Example: Memorial creation schema
const insertMemorialSchema = createInsertSchema(memorials).omit({
  id: true,
  createdAt: true,
  inviteCode: true // Auto-generated
}).extend({
  name: z.string().min(1).max(200),
  biography: z.string().max(10000).optional(),
  birthDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  deathDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  religion: z.string().max(100).optional()
});

// Applied to all requests
app.post("/api/memorials", isAuthenticated, async (req, res) => {
  try {
    const validated = insertMemorialSchema.parse(req.body);
    // Proceed with validated data
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({ errors: error.errors });
    }
  }
});
```

**Content Moderation:**
- Server-side profanity filtering
- Inappropriate language detection
- Applied to: biographies, messages, comments, captions
- Rejection with specific flagged words identified

**SQL Injection Prevention:**
- Parameterized queries via Drizzle ORM
- No raw SQL string concatenation
- Type-safe query builders

**XSS Prevention:**
- React auto-escapes rendered content
- No dangerouslySetInnerHTML usage
- Content Security Policy headers

### 10.4 Privacy Protections

**Data Minimization:**
- Only collect necessary fields
- Optional email addresses for many features
- Anonymous donation support
- Guest user participation without account

**Privacy Controls:**
- Memorial visibility toggle (public/private)
- User settings for notification preferences
- Sharing activity opt-in/opt-out
- Public profile toggle

**Data Deletion:**
- Cascade deletes ensure complete removal
- User account deletion removes all associated data
- Memorial deletion removes all memories, comments, reactions
- Right to be forgotten compliance

**Third-Party Data Sharing:**
- Stripe: Only payment processing data
- Google Analytics: Anonymous usage statistics
- Plausible: Privacy-focused analytics (no cookies)
- No data sold to third parties

### 10.5 Prison Access Audit System

**Comprehensive Logging:**
```typescript
interface PrisonAuditLog {
  id: string;
  requestId: string | null;
  sessionId: string | null;
  action: string; // "request_created", "status_changed", "token_validated", etc.
  performedBy: string;
  ipAddress: string | null;
  userAgent: string | null;
  metadata: Record<string, any>;
  createdAt: Date;
}

// All actions logged
const auditableActions = [
  'request_created',
  'verification_submitted',
  'payment_processed',
  'status_changed',
  'session_created',
  'token_validated',
  'token_expired',
  'session_deactivated'
];
```

**Monitoring & Alerts:**
- Failed token validation attempts
- Multiple access requests from same IP
- Unusual session duration patterns
- Expired token usage attempts

**Compliance:**
- Complete audit trail for correctional facility requirements
- Timestamp precision to the second
- Immutable log records (insert-only table)
- IP address and user agent tracking

---

## 11. INTEGRATION ECOSYSTEM

### 11.1 Payment Processing

**Stripe Integration:**
- Elements UI for PCI-compliant card entry
- Payment Intent API for server-side security
- Webhook handling for payment confirmation
- Automated commission calculations
- Refund support for failed transactions

**Correctional Facility Payment Systems:**
- ConnectNetwork/GTL API integration
- ViaPath Technologies payment processing
- Securus Technologies billing integration
- Account verification workflows
- Balance checking and deduction

### 11.2 Analytics Platforms

**Google Analytics 4:**
- Page view tracking
- Event tracking (memorial creation, donations, etc.)
- User demographics (when available)
- Traffic sources and referrals
- Conversion funnel analysis

**Plausible Analytics:**
- Privacy-focused alternative
- No cookie usage
- GDPR compliant by default
- Real-time visitor counts
- Geographic distribution

### 11.3 Mobile Platform Integration

**Capacitor Framework:**
- iOS app deployment capability
- Android app deployment capability
- Native device features:
  - Camera access for photo uploads
  - Push notifications for memorial updates
  - Offline storage and sync
  - Biometric authentication support
  - Share sheet integration

**PWA Features:**
- Add to Home Screen prompts
- Offline content caching
- Background sync for uploads
- Service worker updates
- Installability criteria compliance

### 11.4 Email & Notification Services

**Email Delivery:**
- Transactional emails (confirmation, password reset)
- Future message delivery
- Payment receipts
- Memorial invitation emails
- Partner notification emails

**Push Notifications:**
- Memorial update alerts
- Donation notifications
- Event reminders
- Comment/condolence notifications
- Admin approval notifications

### 11.5 QR Code Technology

**QR Code Library:**
- `qrcode` npm package
- PNG and SVG generation
- Error correction level: Medium (15%)
- Quiet zone enforcement
- URL encoding with parameters

**PDF Generation:**
- `pdf-lib` for document creation
- Custom branding and styling
- High-resolution output (300 DPI)
- Print-ready formatting
- Weather-resistant design specifications

---

## 12. APPENDICES

### Appendix A: Technology Stack Summary

**Frontend:**
- React 18
- TypeScript
- Vite
- Wouter (routing)
- TanStack Query v5
- Tailwind CSS
- Radix UI + Shadcn/ui
- Lucide React (icons)
- Recharts (analytics charts)
- React Hook Form + Zod

**Backend:**
- Node.js
- Express.js
- TypeScript
- Drizzle ORM
- PostgreSQL (Neon)
- Replit Auth (OIDC)
- Stripe SDK
- QRCode library
- PDF-lib

**Infrastructure:**
- Replit Reserved VM ($20/month)
- 0.5 vCPU / 2GB RAM
- PostgreSQL database
- HTTPS with automatic TLS
- CDN for static assets

**Mobile:**
- Capacitor (iOS + Android)
- PWA with offline support
- Service worker caching

**Analytics:**
- Google Analytics 4
- Plausible Analytics

### Appendix B: API Endpoint Reference

*Complete list of 80+ API endpoints organized by feature area*

**Authentication & Users:**
```
GET    /api/auth/user
POST   /api/login
POST   /api/logout
GET    /api/callback
PUT    /api/user/profile
DELETE /api/user/account
GET    /api/user/settings
PUT    /api/user/settings
```

**Memorials:**
```
POST   /api/memorials
GET    /api/memorials
GET    /api/memorials/:id
PUT    /api/memorials/:id
DELETE /api/memorials/:id
GET    /api/memorials/:id/admins
POST   /api/memorials/:id/admins
DELETE /api/memorials/:memorialId/admins/:adminId
```

**QR Codes:**
```
POST   /api/qr-codes
GET    /api/qr-codes/:memorialId
GET    /api/qr-codes/:id/pdf
PUT    /api/qr-codes/:id
DELETE /api/qr-codes/:id
```

**Memories (Gallery):**
```
POST   /api/memories
GET    /api/memories/:memorialId
PUT    /api/memories/:id
DELETE /api/memories/:id
POST   /api/memories/:id/approve
POST   /api/memories/:id/comments
GET    /api/memories/:id/comments
POST   /api/memories/:id/reactions
DELETE /api/memories/:memoryId/reactions/:userId
GET    /api/memories/:id/reactions/count
```

**Future Messages:**
```
POST   /api/scheduled-messages
GET    /api/scheduled-messages/:memorialId
GET    /api/scheduled-messages/all
PUT    /api/scheduled-messages/:id
DELETE /api/scheduled-messages/:id
GET    /api/message-templates
GET    /api/message-templates/:eventType
```

**Fundraising:**
```
POST   /api/fundraisers
GET    /api/fundraisers/:memorialId
PUT    /api/fundraisers/:id
POST   /api/donations
GET    /api/donations/:fundraiserId
POST   /api/create-payment-intent
POST   /api/stripe-webhook
```

**Celebrity Memorials:**
```
POST   /api/celebrity-memorials
GET    /api/celebrity-memorials
GET    /api/celebrity-memorials/:id
PUT    /api/celebrity-memorials/:id/verify
POST   /api/celebrity-donations
POST   /api/celebrity-fan-content
GET    /api/celebrity-fan-content/:celebrityId
PUT    /api/celebrity-fan-content/:id/publish
```

**Hood Memorials:**
```
POST   /api/hood-memorials
GET    /api/hood-memorials
GET    /api/hood-memorials/:id
GET    /api/hood-memorials/search
POST   /api/neighborhoods
GET    /api/neighborhoods
GET    /api/neighborhoods/:id
```

**Prison Access:**
```
GET    /api/prison/facilities
POST   /api/prison/facilities
POST   /api/prison/access-requests
GET    /api/prison/access-requests
GET    /api/prison/access-requests/:id
PUT    /api/prison/access-requests/:id/status
POST   /api/prison/verifications
GET    /api/prison/verifications/:requestId
POST   /api/prison/payments
PUT    /api/prison/payments/:id/confirm
POST   /api/prison/sessions
POST   /api/prison/sessions/validate
PUT    /api/prison/sessions/:id/deactivate
GET    /api/prison/audit-logs/:requestId
```

**Funeral Programs:**
```
POST   /api/funeral-programs
GET    /api/funeral-programs/:memorialId
PUT    /api/funeral-programs/:id
DELETE /api/funeral-programs/:id
POST   /api/program-items
GET    /api/program-items/:programId
PUT    /api/program-items/:id
DELETE /api/program-items/:id
```

**Business Partnerships:**
```
POST   /api/funeral-home-partners
GET    /api/funeral-home-partners
POST   /api/partner-referrals
GET    /api/partner-commissions/:partnerId
POST   /api/flower-shop-partners
GET    /api/flower-shop-partners
POST   /api/flower-orders
GET    /api/flower-orders/:memorialId
GET    /api/flower-commissions/:shopId
```

**Events & Streams:**
```
POST   /api/legacy-events
GET    /api/legacy-events/:memorialId
POST   /api/memorial-live-streams
GET    /api/memorial-live-streams/:memorialId
PUT    /api/memorial-live-streams/:id
POST   /api/live-stream-viewers
```

**Admin & Analytics:**
```
GET    /api/admin/dashboard
GET    /api/admin/users
GET    /api/admin/memorials
PUT    /api/admin/verify-celebrity/:id
GET    /api/analytics/page-views
POST   /api/analytics/events
```

### Appendix C: Database Schema ERD

*[Entity Relationship Diagram would be included showing relationships between all 50 tables]*

Key relationships:
- Memorials → (one-to-many) → Memories, QR Codes, Scheduled Messages, Fundraisers
- Users → (one-to-many) → Memorials Created, Saved Memorials, Comments
- Fundraisers → (one-to-many) → Donations
- Celebrity Memorials → (one-to-many) → Celebrity Donations, Fan Content
- Prison Access Requests → (one-to-many) → Verifications, Payments, Sessions, Audit Logs
- Funeral Programs → (one-to-many) → Program Items

### Appendix D: Color and Design Specifications

**Primary Color Palette:**
- Rich Purple: HSL(280°, 75%, 40%) = #6B0DAC
- Gold Accent: HSL(45°, 85%, 45%) = #D4AF37
- Background: HSL(280°, 100%, 5%) = #1A0033
- Text Light: HSL(0°, 0%, 95%) = #F2F2F2

**Typography:**
- Headings: Crimson Text (serif)
- Body: Inter (sans-serif)
- Monospace: Source Code Pro

**Spiritual Symbol Library:**
21 icons representing major world religions and spiritual traditions

**Responsive Breakpoints:**
- Mobile: 320px - 767px
- Tablet: 768px - 1023px
- Desktop: 1024px+

### Appendix E: Performance Metrics

**Current Performance (Production):**
- API Response Times: 1-6ms (development), <300ms (production)
- Database Query Times: <50ms for indexed queries
- Page Load Time: <2 seconds (first visit), <500ms (cached)
- Mobile Lighthouse Score: 90+ (Performance, Accessibility, Best Practices, SEO)

**Scalability Targets:**
- Support 100,000+ concurrent memorials
- Handle 1,000 req/sec on API endpoints
- 99.9% uptime SLA
- <100ms p95 API response time

### Appendix F: Deployment Configuration

**Reserved VM Specifications:**
- Provider: Replit
- Plan: Reserved VM ($20/month)
- Resources: 0.5 vCPU, 2GB RAM
- Eliminates cold start delays (previously 1000+ms on Autoscale)
- Consistent <300ms response times

**Database:**
- Provider: Neon (PostgreSQL serverless)
- Region: US East
- Connection pooling enabled
- Automated backups
- Point-in-time recovery

**Domain Configuration:**
- Primary: [app-name].replit.app
- Custom domain support available
- Automatic HTTPS/TLS certificates
- CDN for static asset delivery

---

## CONCLUSION

This comprehensive patent documentation describes the Opictuary digital memorial platform, a novel system integrating:

1. **Physical-digital memorial bridging** via dynamic QR codes
2. **Specialized access control** for incarcerated populations
3. **Temporal legacy messaging** with recurrence patterns
4. **Community memorial networks** (Hood Memorials)
5. **Multi-faith spiritual customization** (21 traditions)
6. **Integrated business partnerships** with automated commission tracking
7. **Comprehensive funeral service tools** (programs, livestreaming, audio sync)

The platform addresses significant unmet needs in the digital memorial space, provides clear revenue opportunities, and demonstrates technical innovation across multiple domains including security, database architecture, payment processing, and multi-platform deployment.

**Recommended Next Steps:**
1. Consult with patent attorney specializing in software/business methods
2. Conduct prior art search for similar systems
3. File provisional patent application to establish priority date
4. Prepare formal patent claims with attorney guidance
5. Consider international patent protection (PCT application)

---

**Document Prepared By:** Replit Agent
**Date:** November 6, 2025
**Version:** 1.0
**Total Pages:** [Would be 60-80 pages in formatted document]

---

*END OF PATENT DOCUMENTATION*
